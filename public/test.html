<!DOCTYPE html>
<html id="html" lang="" class="intelligent" style="
        --themecolor-R:0;
        --themecolor-G: 255;
        --themecolor-B: 255;
        --themecolor-H:180;
        --themecolor-S:100;
        --themecolor-L:50;
        --color-white:#adb5bd;
        --radius:8px;
        --bgImg3:url(http://127.0.0.1/images/11.jfif);">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>

 
  <audio id='aa' ref="audio" src="http://127.0.0.1/uploadfile/music/夜空中最亮的星.mp3" autoplay></audio>
  <!-- <video id="aa" controls="" autoplay="" name="media"><source id="bb" src="http://127.0.0.1/uploadfile/music/夜空中最亮的星.mp3" type="audio/mpeg"></video> -->
  <canvas id="myCanvas" width="578" height="200"></canvas>
  <button id="button">按钮</button>
</body>
</html>

<script>
  const aaa = document.getElementById('aa')
  const button = document.getElementById('button')
  button.onclick = function(){
    canvas(aaa)
  }
//   if(aaa){
//     // canvas(aaa)
//     setInterval(() => {
//   canvas(aaa)
// }, 3000)
//   }
  
  function canvas(audio) {
    console.log(audio)
    const context = new (window.AudioContext || window.webkitAudioContext)(); //new AudioContext();
    
    const src = context.createMediaElementSource(audio);
    const analyser = context.createAnalyser();

    const canvas = document.getElementById("myCanvas");

    canvas.width = '1000';
    canvas.height = '40';
    const ctx = canvas.getContext("2d");

    src.connect(analyser);
    analyser.connect(context.destination);

    analyser.fftSize = 256;

    const bufferLength = analyser.frequencyBinCount;
    console.log(bufferLength)

    const dataArray = new Uint8Array(bufferLength);

    const WIDTH = canvas.width;
    const HEIGHT = canvas.height;

    const barWidth = (WIDTH / bufferLength) * 0.5;
    let barHeight;
    let x = 0;

    function renderFrame() {
        requestAnimationFrame(renderFrame);

        x = 0;

        analyser.getByteFrequencyData(dataArray);

        const html = document.getElementById("html");
        if (['daylight'].includes(html.className)) {
            ctx.fillStyle = '#ffffff';
        }

        else if (['moonlight'].includes(html.className)) {
            ctx.fillStyle = '#282837';
        } else {
            var r = html.style.cssText.split(';')[0].split(':')[1]
            var g = html.style.cssText.split(';')[1].split(':')[1]
            var b = html.style.cssText.split(';')[2].split(':')[1]
            const rgb = `rgba(${30 * 0.75 + r * (1 - 0.75)},${30 * 0.75 + g * (1 - 0.75)},${30 * 0.75 + b * (1 - 0.75)})`
            ctx.fillStyle = 'red';
        }

        ctx.fillRect(0, 0, WIDTH, HEIGHT);

        const my_gradient = ctx.createLinearGradient(0, 0, 0, 200);
            my_gradient.addColorStop(1, "rgb(255, 0, 221)");
            ctx.fillStyle = my_gradient

        for (let i = 0; i < bufferLength; i++) {
            barHeight = dataArray[i];
            console.log(barHeight)

            ctx.fillRect(x, (300 - barHeight)/8, barWidth, barHeight/8);

            x += barWidth + 1;
        }
    }

    renderFrame();

}

  </script>
